name: Publish NPM Packages

on:
  push:
    branches:
      - main
    paths:
      - "packages/**"
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      packages:
        description: 'Packages to publish (comma-separated, e.g., core,react or "all")'
        required: false
        default: "all"
        type: string
      core_version:
        description: "Version for @auth0-web-ui-components/core (e.g., 1.2.3, 1.0.0-beta.1). If empty, uses version from package.json"
        required: false
        type: string
      react_version:
        description: "Version for @auth0-web-ui-components/react (e.g., 0.2.0, 0.1.0-beta.1). If empty, uses version from package.json"
        required: false
        type: string
      dry_run:
        description: "Dry run (skip actual publishing)"
        required: false
        default: false
        type: boolean
      skip_slack_notification:
        description: "Skip Slack notification"
        required: false
        default: false
        type: boolean

jobs:
  publish:
    runs-on:
      labels: ubuntu-22.04-2cpu-8ram-75ssd
    permissions:
      contents: write # to be able to clone the repo and commit version updates
      id-token: write # to enable use of OIDC for npm provenance
      pull-requests: write # to create and manage pull requests

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Import GPG key for commit signing
        id: import-gpg
        uses: crazy-max/ghaction-import-gpg@01dd5d3ca463c7f10f7f4f7b4f177225ac661ee4 # v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          git_user_signingkey: true
          git_commit_gpgsign: true

      - name: Setup pnpm
        uses: pnpm/action-setup@36de12bed180fa130ed56a35e7344f2fa7a820ab # v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Setup JFrog CLI
        id: setup-jfrog-cli
        uses: jfrog/setup-jfrog-cli@f0a84f35b0e0bd21838c5fb3e6788072d6540d13 # v4.6.0 at 2025-01-02
        env:
          JF_URL: https://a0us.jfrog.io
        with:
          oidc-provider-name: atko-cic

      - name: Setup NPM Authentication
        env:
          ARTIFACTORY_USER: ${{ steps.setup-jfrog-cli.outputs.oidc-user }}
          ARTIFACTORY_API_TOKEN: ${{ steps.setup-jfrog-cli.outputs.oidc-token }}
        run: |
          curl -u $ARTIFACTORY_USER:$ARTIFACTORY_API_TOKEN https://a0us.jfrog.io/artifactory/api/npm/npm/auth/a0 > ~/.npmrc
          echo "registry=https://a0us.jfrog.io/artifactory/api/npm/npm/" >> ~/.npmrc
          echo "@auth0-web-ui-components:registry=https://a0us.jfrog.io/artifactory/api/npm/npm/" >> ~/.npmrc

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm run build

      - name: Auto-bump versions for manual dispatch
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.core_version == '' && github.event.inputs.react_version == ''
        run: |
          echo "Auto-bumping patch versions for manual workflow run"

          # Bump patch version for core package
          if [ -d "./packages/core" ]; then
            cd "./packages/core"
            current=$(node -p "require('./package.json').version")
            new_version=$(node -e "
              const pkg = require('./package.json');
              const [major, minor, patch] = pkg.version.split('.').map(Number);
              const newVersion = \`\${major}.\${minor}.\${patch + 1}\`;
              pkg.version = newVersion;
              require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
              console.log(newVersion);
            ")
            echo "Bumped @auth0-web-ui-components/core: $current -> $new_version"
            cd - > /dev/null
          fi

          # Bump patch version for react package
          if [ -d "./packages/react" ]; then
            cd "./packages/react"
            current=$(node -p "require('./package.json').version")
            new_version=$(node -e "
              const pkg = require('./package.json');
              const [major, minor, patch] = pkg.version.split('.').map(Number);
              const newVersion = \`\${major}.\${minor}.\${patch + 1}\`;
              pkg.version = newVersion;
              require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
              console.log(newVersion);
            ")
            echo "Bumped @auth0-web-ui-components/react: $current -> $new_version"
            cd - > /dev/null
          fi

      - name: Update package versions on main push
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          set -e
          echo "Auto-bumping versions for main branch push"

          UPDATED_PACKAGES=()

          # Check what packages have changes
          core_changes=$(git diff --name-only HEAD~1 HEAD | grep "^packages/core/" || true)
          react_changes=$(git diff --name-only HEAD~1 HEAD | grep "^packages/react/" || true)

          # Bump core package if it has changes
          if [ -n "$core_changes" ] && [ -d "./packages/core" ]; then
            echo "Detected changes in core package"
            cd "./packages/core"
            current=$(node -p "require('./package.json').version")
            new_version=$(node -e "
              const pkg = require('./package.json');
              const [major, minor, patch] = pkg.version.split('.').map(Number);
              const newVersion = \`\${major}.\${minor + 1}.0\`;
              pkg.version = newVersion;
              require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
              console.log(newVersion);
            ")
            echo "Bumped @auth0-web-ui-components/core: $current -> $new_version"
            UPDATED_PACKAGES+=("@auth0-web-ui-components/core@$new_version")
            cd - > /dev/null
          fi

          # Bump react package if it has changes  
          if [ -n "$react_changes" ] && [ -d "./packages/react" ]; then
            echo "Detected changes in react package"
            cd "./packages/react"
            current=$(node -p "require('./package.json').version")
            new_version=$(node -e "
              const pkg = require('./package.json');
              const [major, minor, patch] = pkg.version.split('.').map(Number);
              const newVersion = \`\${major}.\${minor + 1}.0\`;
              pkg.version = newVersion;
              require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
              console.log(newVersion);
            ")
            echo "Bumped @auth0-web-ui-components/react: $current -> $new_version"
            UPDATED_PACKAGES+=("@auth0-web-ui-components/react@$new_version")
            cd - > /dev/null
          fi

          # Store info for PR creation
          if [ ${#UPDATED_PACKAGES[@]} -gt 0 ]; then
            echo "HAS_VERSION_UPDATES=true" >> $GITHUB_ENV
            echo "UPDATED_PACKAGES_LIST=${UPDATED_PACKAGES[@]}" >> $GITHUB_ENV
            echo "Version updates prepared for PR creation"
          else
            echo "HAS_VERSION_UPDATES=false" >> $GITHUB_ENV
            echo "No package changes detected"
          fi

      - name: Set manual version updates
        if: github.event.inputs.core_version != '' || github.event.inputs.react_version != ''
        run: |
          # Handle core package version
          if [ -n "${{ github.event.inputs.core_version }}" ]; then
            cd "./packages/core"
            node -e "
              const pkg = require('./package.json');
              pkg.version = '${{ github.event.inputs.core_version }}';
              require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
            "
            echo "CORE_VERSION=${{ github.event.inputs.core_version }}" >> $GITHUB_ENV
            cd - > /dev/null
          fi

          # Handle react package version
          if [ -n "${{ github.event.inputs.react_version }}" ]; then
            cd "./packages/react"
            node -e "
              const pkg = require('./package.json');
              pkg.version = '${{ github.event.inputs.react_version }}';
              require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
            "
            echo "REACT_VERSION=${{ github.event.inputs.react_version }}" >> $GITHUB_ENV
            cd - > /dev/null
          fi

      - name: Determine packages to publish
        id: packages
        run: |
          PACKAGES_TO_PUBLISH=""

          if [ "${{ github.event.inputs.packages }}" != "" ] && [ "${{ github.event.inputs.packages }}" != "all" ]; then
            # Manual package selection
            PACKAGES_TO_PUBLISH="${{ github.event.inputs.packages }}"
            echo "üì¶ Manual selection: $PACKAGES_TO_PUBLISH"
          else
            # Auto-detect packages to publish based on changes/updates
            if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              # For manual dispatch, publish all packages by default
              PACKAGES_TO_PUBLISH="core,react"
            else
              # For push events, detect changed packages
              core_changes=$(git diff --name-only HEAD~1 HEAD | grep "^packages/core/" || true)
              react_changes=$(git diff --name-only HEAD~1 HEAD | grep "^packages/react/" || true)
              
              PACKAGES_ARRAY=()
              if [ -n "$core_changes" ]; then
                PACKAGES_ARRAY+=("core")
              fi
              if [ -n "$react_changes" ]; then
                PACKAGES_ARRAY+=("react")
              fi
              
              # Join array with commas
              IFS=','
              PACKAGES_TO_PUBLISH="${PACKAGES_ARRAY[*]}"
              IFS=' '
            fi
          fi

          echo "packages=$PACKAGES_TO_PUBLISH" >> $GITHUB_OUTPUT
          echo "Packages to publish: ${PACKAGES_TO_PUBLISH:-'none'}"

      - name: Publish Core package
        id: publish-core
        if: contains(steps.packages.outputs.packages, 'core') && steps.packages.outputs.packages != ''
        working-directory: ./packages/core
        run: |
          current_version=$(node -p "require('./package.json').version")
          echo "Publishing @auth0-web-ui-components/core@$current_version"

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "DRY RUN: Skipping actual publish"
            pnpm publish --dry-run --access public --no-git-checks
            echo "published=dry-run" >> $GITHUB_OUTPUT
            echo "version=$current_version" >> $GITHUB_OUTPUT
          else
            pnpm publish --access public --no-git-checks
            echo "Successfully published @auth0-web-ui-components/core@$current_version"
            echo "published=true" >> $GITHUB_OUTPUT
            echo "version=$current_version" >> $GITHUB_OUTPUT
          fi
        env:
          NODE_AUTH_TOKEN: ${{ steps.setup-jfrog-cli.outputs.oidc-token }}

      - name: Publish React package
        id: publish-react
        if: contains(steps.packages.outputs.packages, 'react') && steps.packages.outputs.packages != ''
        working-directory: ./packages/react
        run: |
          current_version=$(node -p "require('./package.json').version")
          echo "Publishing @auth0-web-ui-components/react@$current_version"

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "DRY RUN: Skipping actual publish"
            pnpm publish --dry-run --access public --no-git-checks
            echo "published=dry-run" >> $GITHUB_OUTPUT
            echo "version=$current_version" >> $GITHUB_OUTPUT
          else
            pnpm publish --access public --no-git-checks
            echo "Successfully published @auth0-web-ui-components/react@$current_version"
            echo "published=true" >> $GITHUB_OUTPUT
            echo "version=$current_version" >> $GITHUB_OUTPUT
          fi
        env:
          NODE_AUTH_TOKEN: ${{ steps.setup-jfrog-cli.outputs.oidc-token }}

      - name: Import GPG key for signing commits
        if: |
          github.event_name == 'workflow_dispatch' && 
          github.event.inputs.core_version == '' && 
          github.event.inputs.react_version == '' &&
          steps.packages.outputs.packages != ''
        id: import-gpg-pr
        uses: crazy-max/ghaction-import-gpg@01dd5d3ca463c7f10f7f4f7b4f177225ac661ee4 # v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          git_user_signingkey: true
          git_commit_gpgsign: true
          git_config_global: true
          git_tag_gpgsign: true

      - name: Create Pull Request with version updates (workflow_dispatch)
        id: cpr
        if: |
          github.event_name == 'workflow_dispatch' && 
          github.event.inputs.core_version == '' && 
          github.event.inputs.react_version == '' &&
          steps.packages.outputs.packages != ''
        uses: peter-evans/create-pull-request@c5a7806660adbe173f04e3e038b0ccdcd758773c # v6.1.0
        with:
          token: ${{ secrets.PAT }}
          commit-message: |
            chore: auto-bump package versions after publish

            Updated packages: ${{ steps.packages.outputs.packages }}
          committer: Harish Sundar <harish.sundar@okta.com>
          author: Harish Sundar <harish.sundar@okta.com>
          signoff: false
          branch: auto-version-bump-${{ github.run_id }}
          delete-branch: true
          title: "chore: auto-bump package versions after publish"
          body: |
            ü§ñ **Automated version bump after NPM package publish**

            This PR contains version updates that were automatically applied after publishing packages to JFrog Artifactory.

            ## üì¶ Updated Packages
            Published packages: `${{ steps.packages.outputs.packages }}`

            ## üîó Related
            - GitHub Actions Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ## ‚ö†Ô∏è Action Required
            **This PR will be automatically approved.** The packages have already been published to JFrog Artifactory, and the version updates will be committed back to the repository.

            Commits are signed with GPG key for harish.sundar@okta.com.

      - name: Import GPG key for version bump PR
        if: |
          github.event_name == 'push' && 
          github.ref == 'refs/heads/main' &&
          env.HAS_VERSION_UPDATES == 'true'
        id: import-gpg-version
        uses: crazy-max/ghaction-import-gpg@01dd5d3ca463c7f10f7f4f7b4f177225ac661ee4 # v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          git_user_signingkey: true
          git_commit_gpgsign: true
          git_config_global: true
          git_tag_gpgsign: true

      - name: Create Pull Request with version updates (push)
        id: cpr-version
        if: |
          github.event_name == 'push' && 
          github.ref == 'refs/heads/main' &&
          env.HAS_VERSION_UPDATES == 'true'
        uses: peter-evans/create-pull-request@c5a7806660adbe173f04e3e038b0ccdcd758773c # v6.1.0
        with:
          token: ${{ secrets.PAT }}
          commit-message: |
            chore: bump package versions

            ${{ env.UPDATED_PACKAGES_LIST }}
          committer: Harish Sundar <harish.sundar@okta.com>
          author: Harish Sundar <harish.sundar@okta.com>
          signoff: false
          branch: version-bump-${{ github.run_id }}
          delete-branch: true
          title: "chore: bump package versions"
          body: |
            ü§ñ **Automated version bump after merge to main**

            This PR contains version updates that were automatically applied after detecting changes in packages.

            ## üì¶ Updated Packages
            ${{ env.UPDATED_PACKAGES_LIST }}

            ## üîó Related
            - GitHub Actions Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            - Triggered by commit: ${{ github.sha }}

            ## ‚ö†Ô∏è Action Required
            **This PR will be automatically approved.** Version bumps have been calculated and will be committed back to the repository.

            Commits are signed with GPG key for harish.sundar@okta.com.

      - name: Auto approve (workflow_dispatch)
        if: steps.cpr.outputs.pull-request-operation == 'created'
        uses: juliangruber/approve-pull-request-action@f83b836abaed1b3ab639ae61f9117c52ae405f65 # v2.0.7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          number: ${{ steps.cpr.outputs.pull-request-number }}

      - name: Auto approve (push)
        if: steps.cpr-version.outputs.pull-request-operation == 'created'
        uses: juliangruber/approve-pull-request-action@f83b836abaed1b3ab639ae61f9117c52ae405f65 # v2.0.7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          number: ${{ steps.cpr-version.outputs.pull-request-number }}

      - name: No packages to publish
        if: steps.packages.outputs.packages == ''
        run: |
          echo "## ‚ö†Ô∏è No Packages to Publish" >> $GITHUB_STEP_SUMMARY
          echo "No packages detected for publishing. This can happen when:" >> $GITHUB_STEP_SUMMARY
          echo "- No changes were detected in any package" >> $GITHUB_STEP_SUMMARY
          echo "- Package versions are already up to date" >> $GITHUB_STEP_SUMMARY
          echo "- Manual package selection excluded all packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üí° **Tip:** Use manual version inputs to force publish specific packages" >> $GITHUB_STEP_SUMMARY

      - name: Generate workflow summary
        if: steps.packages.outputs.packages != ''
        run: |
          echo "## NPM Packages Published" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.packages.outputs.packages }}" == *"core"* ]]; then
            CORE_VERSION=$(node -p "require('./packages/core/package.json').version" 2>/dev/null || echo "unknown")
            echo "- @auth0-web-ui-components/core@$CORE_VERSION" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ steps.packages.outputs.packages }}" == *"react"* ]]; then
            REACT_VERSION=$(node -p "require('./packages/react/package.json').version" 2>/dev/null || echo "unknown")
            echo "- @auth0-web-ui-components/react@$REACT_VERSION" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** https://a0us.jfrog.io" >> $GITHUB_STEP_SUMMARY

      - name: Send Slack notification
        if: always() && !cancelled() && github.event.inputs.dry_run != 'true' && github.event.inputs.skip_slack_notification != 'true'
        run: |
          # Determine what was actually published
          PUBLISHED_PACKAGES=""
          PUBLISH_ERRORS=""

          # Check core package publishing
          if [ "${{ steps.publish-core.outputs.published }}" = "true" ]; then
            PUBLISHED_PACKAGES="@auth0-web-ui-components/core@${{ steps.publish-core.outputs.version }}"
          elif [ "${{ steps.publish-core.outcome }}" = "failure" ]; then
            PUBLISH_ERRORS="core package failed to publish"
          fi

          # Check react package publishing
          if [ "${{ steps.publish-react.outputs.published }}" = "true" ]; then
            if [ -n "$PUBLISHED_PACKAGES" ]; then
              PUBLISHED_PACKAGES="$PUBLISHED_PACKAGES, @auth0-web-ui-components/react@${{ steps.publish-react.outputs.version }}"
            else
              PUBLISHED_PACKAGES="@auth0-web-ui-components/react@${{ steps.publish-react.outputs.version }}"
            fi
          elif [ "${{ steps.publish-react.outcome }}" = "failure" ]; then
            if [ -n "$PUBLISH_ERRORS" ]; then
              PUBLISH_ERRORS="$PUBLISH_ERRORS, react package failed to publish"
            else
              PUBLISH_ERRORS="react package failed to publish"
            fi
          fi

          # Determine overall status and message
          if [ -z "${{ steps.packages.outputs.packages }}" ]; then
            STATUS="‚ÑπÔ∏è No packages published"
            MESSAGE="No changes detected in packages"
          elif [ -n "$PUBLISHED_PACKAGES" ] && [ -z "$PUBLISH_ERRORS" ]; then
            # All packages published successfully
            if [ "${{ steps.cpr.outcome }}" = "success" ]; then
              STATUS="‚úÖ Packages published successfully"
              MESSAGE="Published: $PUBLISHED_PACKAGES. PR created for version updates."
            elif [ "${{ steps.cpr.outcome }}" = "failure" ]; then
              STATUS="‚ö†Ô∏è Packages published, PR creation failed"  
              MESSAGE="Published: $PUBLISHED_PACKAGES. ‚ùå PR creation failed - manual version update needed."
            elif [ "${{ steps.cpr.outcome }}" = "skipped" ]; then
              STATUS="‚úÖ Packages published successfully"
              MESSAGE="Published: $PUBLISHED_PACKAGES. No PR needed."
            else
              STATUS="‚úÖ Packages published successfully"
              MESSAGE="Published: $PUBLISHED_PACKAGES"
            fi
          elif [ -n "$PUBLISHED_PACKAGES" ] && [ -n "$PUBLISH_ERRORS" ]; then
            # Some packages published, some failed
            STATUS="‚ö†Ô∏è Partial publishing failure"
            MESSAGE="‚úÖ Published: $PUBLISHED_PACKAGES. ‚ùå Errors: $PUBLISH_ERRORS"
          elif [ -n "$PUBLISH_ERRORS" ]; then
            # All packages failed to publish
            STATUS="‚ùå Package publishing failed"
            MESSAGE="Errors: $PUBLISH_ERRORS"
          else
            # Fallback for unexpected states
            STATUS="‚ùì Workflow completed with unknown state"
            MESSAGE="Check workflow logs for details"
          fi

          # Get individual package versions for Slack
          CORE_VERSION="Not published"
          REACT_VERSION="Not published"

          if [ "${{ steps.publish-core.outputs.published }}" = "true" ]; then
            CORE_VERSION="${{ steps.publish-core.outputs.version }}"
          fi

          if [ "${{ steps.publish-react.outputs.published }}" = "true" ]; then
            REACT_VERSION="${{ steps.publish-react.outputs.version }}"
          fi

          # Send notification to Slack (if webhook is configured)
          if [ -n "${{ secrets.SLACK_WORKFLOW_WEBHOOK }}" ]; then
            curl -X POST "${{ secrets.SLACK_WORKFLOW_WEBHOOK }}" \
              -H "Content-Type: application/json" \
              -d "{
                \"status\": \"$STATUS\",
                \"package_details\": \"${PUBLISHED_PACKAGES:-'No packages published'}\",
                \"core_version\": \"$CORE_VERSION\",
                \"react_version\": \"$REACT_VERSION\",
                \"action_url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
              }" || echo "Failed to send Slack notification"
          else
            echo "Slack webhook not configured, skipping notification"
          fi

          # Also output summary for GitHub logs
          echo "=== WORKFLOW SUMMARY ==="
          echo "$STATUS"
          echo "$MESSAGE"
