name: Publish to Public NPM

on:
  workflow_dispatch:
    inputs:
      core_version:
        description: "Core package version (leave empty to use package.json version)"
        required: false
        type: string
      react_version:
        description: "React package version (leave empty to use package.json version)"
        required: false
        type: string
      packages:
        description: "Packages to publish"
        required: true
        type: choice
        default: "both"
        options:
          - "both"
          - "core"
          - "react"
      npm_tag:
        description: "NPM dist-tag (auto = detect from version)"
        required: false
        type: choice
        default: "auto"
        options:
          - "auto"
          - "latest"
          - "beta"
          - "alpha"
          - "next"
      dry_run:
        description: "Dry run (preview without publishing)"
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  id-token: write

jobs:
  publish:
    name: Build & Publish to Public NPM
    runs-on: ubuntu-22.04-2cpu-8ram-75ssd
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.6.5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm run build

      - name: Detect versions and npm tags
        id: detect
        run: |
          CORE_VERSION=$(node -p "require('./packages/core/package.json').version")
          REACT_VERSION=$(node -p "require('./packages/react/package.json').version")
          
          echo "core_version=${CORE_VERSION}" >> $GITHUB_OUTPUT
          echo "react_version=${REACT_VERSION}" >> $GITHUB_OUTPUT
          
          determine_tag() {
            local version=$1
            if [[ "$version" == *"alpha"* ]]; then
              echo "alpha"
            elif [[ "$version" == *"beta"* ]]; then
              echo "beta"
            elif [[ "$version" == *"rc"* ]]; then
              echo "next"
            else
              echo "latest"
            fi
          }
          
          CORE_TAG=$(determine_tag "$CORE_VERSION")
          REACT_TAG=$(determine_tag "$REACT_VERSION")
          
          echo "core_npm_tag=${CORE_TAG}" >> $GITHUB_OUTPUT
          echo "react_npm_tag=${REACT_TAG}" >> $GITHUB_OUTPUT
          
          echo "Detected versions:"
          echo "  Core: ${CORE_VERSION} → ${CORE_TAG}"
          echo "  React: ${REACT_VERSION} → ${REACT_TAG}"

      - name: Set final versions and tags
        id: final
        run: |
          CORE_VER="${{ github.event.inputs.core_version }}"
          REACT_VER="${{ github.event.inputs.react_version }}"
          NPM_TAG_INPUT="${{ github.event.inputs.npm_tag }}"
          
          if [ -z "$CORE_VER" ]; then
            CORE_VER="${{ steps.detect.outputs.core_version }}"
          fi
          
          if [ -z "$REACT_VER" ]; then
            REACT_VER="${{ steps.detect.outputs.react_version }}"
          fi
          
          if [ "$NPM_TAG_INPUT" = "auto" ] || [ -z "$NPM_TAG_INPUT" ]; then
            CORE_TAG="${{ steps.detect.outputs.core_npm_tag }}"
            REACT_TAG="${{ steps.detect.outputs.react_npm_tag }}"
          else
            CORE_TAG="$NPM_TAG_INPUT"
            REACT_TAG="$NPM_TAG_INPUT"
          fi
          
          echo "core_version=${CORE_VER}" >> $GITHUB_OUTPUT
          echo "react_version=${REACT_VER}" >> $GITHUB_OUTPUT
          echo "core_tag=${CORE_TAG}" >> $GITHUB_OUTPUT
          echo "react_tag=${REACT_TAG}" >> $GITHUB_OUTPUT
          
          echo "Publishing:"
          echo "  Core: ${CORE_VER} @ ${CORE_TAG}"
          echo "  React: ${REACT_VER} @ ${REACT_TAG}"

      - name: Update Core package for public npm
        if: |
          (github.event.inputs.packages == 'both' || github.event.inputs.packages == 'core')
        working-directory: ./packages/core
        run: |
          node -e "
            const pkg = require('./package.json');
            pkg.version = '${{ steps.final.outputs.core_version }}';
            
            pkg.publishConfig = {
              access: 'public',
              registry: 'https://registry.npmjs.org/'
            };
            
            require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

          echo "Updated @auth0/web-ui-components-core to ${{ steps.final.outputs.core_version }}"

      - name: Update React package for public npm
        if: |
          (github.event.inputs.packages == 'both' || github.event.inputs.packages == 'react')
        working-directory: ./packages/react
        run: |
          node -e "
            const pkg = require('./package.json');
            pkg.version = '${{ steps.final.outputs.react_version }}';
            
            pkg.publishConfig = {
              access: 'public',
              registry: 'https://registry.npmjs.org/'
            };
            
            if (pkg.dependencies && pkg.dependencies['@auth0/web-ui-components-core']) {
              pkg.dependencies['@auth0/web-ui-components-core'] = '${{ steps.final.outputs.core_version }}';
            }
            
            require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

          echo "Updated @auth0/web-ui-components-react to ${{ steps.final.outputs.react_version }}"

      - name: Publish Core package to public npm
        id: publish-core
        if: |
          (github.event.inputs.packages == 'both' || github.event.inputs.packages == 'core')
        working-directory: ./packages/core
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          current_version=$(node -p "require('./package.json').version")
          npm_tag="${{ steps.final.outputs.core_tag }}"
          echo "Publishing @auth0/web-ui-components-core@$current_version with tag: $npm_tag"

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "DRY RUN - Skipping publish"
            pnpm publish --dry-run --no-git-checks --tag $npm_tag
            echo "published=dry-run" >> $GITHUB_OUTPUT
            echo "version=$current_version" >> $GITHUB_OUTPUT
          else
            pnpm publish --provenance --no-git-checks --tag $npm_tag
            echo "published=true" >> $GITHUB_OUTPUT
            echo "version=$current_version" >> $GITHUB_OUTPUT
            echo "Published @auth0/web-ui-components-core@$current_version"
          fi

      - name: Publish React package to public npm
        id: publish-react
        if: |
          (github.event.inputs.packages == 'both' || github.event.inputs.packages == 'react')
        working-directory: ./packages/react
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          current_version=$(node -p "require('./package.json').version")
          npm_tag="${{ steps.final.outputs.react_tag }}"
          echo "Publishing @auth0/web-ui-components-react@$current_version with tag: $npm_tag"

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "DRY RUN - Skipping publish"
            pnpm publish --dry-run --no-git-checks --tag $npm_tag
            echo "published=dry-run" >> $GITHUB_OUTPUT
            echo "version=$current_version" >> $GITHUB_OUTPUT
          else
            pnpm publish --provenance --no-git-checks --tag $npm_tag
            echo "published=true" >> $GITHUB_OUTPUT
            echo "version=$current_version" >> $GITHUB_OUTPUT
            echo "Published @auth0/web-ui-components-react@$current_version"
          fi

      - name: Generate Summary
        run: |
          echo "## Public NPM Publication Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "### DRY RUN MODE" >> $GITHUB_STEP_SUMMARY
            echo "No packages were published. This was a test run." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "### Published Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.publish-core.outputs.published }}" != "" ]; then
            echo "- \`@auth0/web-ui-components-core@${{ steps.final.outputs.core_version }}\`" >> $GITHUB_STEP_SUMMARY
            echo "  - Tag: \`${{ steps.final.outputs.core_tag }}\`" >> $GITHUB_STEP_SUMMARY
            echo "  - Registry: https://registry.npmjs.org" >> $GITHUB_STEP_SUMMARY
            echo "  - Install: \`npm install @auth0/web-ui-components-core@${{ steps.final.outputs.core_tag }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.publish-react.outputs.published }}" != "" ]; then
            echo "- \`@auth0/web-ui-components-react@${{ steps.final.outputs.react_version }}\`" >> $GITHUB_STEP_SUMMARY
            echo "  - Tag: \`${{ steps.final.outputs.react_tag }}\`" >> $GITHUB_STEP_SUMMARY
            echo "  - Registry: https://registry.npmjs.org" >> $GITHUB_STEP_SUMMARY
            echo "  - Install: \`npm install @auth0/web-ui-components-react@${{ steps.final.outputs.react_tag }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "### Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.publish-core.outputs.published }}" != "" ]; then
            echo "- [View @auth0/web-ui-components-core on npm](https://www.npmjs.com/package/@auth0/web-ui-components-core)" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.publish-react.outputs.published }}" != "" ]; then
            echo "- [View @auth0/web-ui-components-react on npm](https://www.npmjs.com/package/@auth0/web-ui-components-react)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Your internal JFrog registry continues to use \`@auth0-web-ui-components/*\` packages." >> $GITHUB_STEP_SUMMARY

      - name: Create Git tags
        if: github.event.inputs.dry_run != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ "${{ steps.publish-core.outputs.published }}" = "true" ]; then
            TAG_NAME="core@${{ steps.final.outputs.core_version }}"
            git tag -a "$TAG_NAME" -m "Release @auth0/web-ui-components-core@${{ steps.final.outputs.core_version }}"
            git push origin "$TAG_NAME"
            echo "Created tag: $TAG_NAME"
          fi

          if [ "${{ steps.publish-react.outputs.published }}" = "true" ]; then
            TAG_NAME="react@${{ steps.final.outputs.react_version }}"
            git tag -a "$TAG_NAME" -m "Release @auth0/web-ui-components-react@${{ steps.final.outputs.react_version }}"
            git push origin "$TAG_NAME"
            echo "Created tag: $TAG_NAME"
          fi

      - name: Create GitHub Release for Core
        if: |
          github.event.inputs.dry_run != 'true' && 
          steps.publish-core.outputs.published == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: core@${{ steps.final.outputs.core_version }}
          name: "@auth0/web-ui-components-core@${{ steps.final.outputs.core_version }}"
          body: |
            Published to NPM
            
            **Package**: `@auth0/web-ui-components-core`
            **Version**: `${{ steps.final.outputs.core_version }}`
            **NPM Tag**: `${{ steps.final.outputs.core_tag }}`
            
            ```bash
            npm install @auth0/web-ui-components-core@${{ steps.final.outputs.core_version }}
            ```
            
            [View on NPM](https://www.npmjs.com/package/@auth0/web-ui-components-core/v/${{ steps.final.outputs.core_version }})
          prerelease: ${{ steps.final.outputs.core_tag != 'latest' }}
          draft: false

      - name: Create GitHub Release for React
        if: |
          github.event.inputs.dry_run != 'true' && 
          steps.publish-react.outputs.published == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: react@${{ steps.final.outputs.react_version }}
          name: "@auth0/web-ui-components-react@${{ steps.final.outputs.react_version }}"
          body: |
            Published to NPM
            
            **Package**: `@auth0/web-ui-components-react`
            **Version**: `${{ steps.final.outputs.react_version }}`
            **NPM Tag**: `${{ steps.final.outputs.react_tag }}`
            **Requires**: `@auth0/web-ui-components-core@${{ steps.final.outputs.core_version }}`
            
            ```bash
            npm install @auth0/web-ui-components-react@${{ steps.final.outputs.react_version }}
            ```
            
            [View on NPM](https://www.npmjs.com/package/@auth0/web-ui-components-react/v/${{ steps.final.outputs.react_version }})
          prerelease: ${{ steps.final.outputs.react_tag != 'latest' }}
          draft: false

      - name: Restore package.json files
        if: always()
        run: |
          git checkout packages/core/package.json packages/react/package.json || true
