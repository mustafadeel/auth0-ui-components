name: Publish to Public NPM

on:
  workflow_dispatch:
    inputs:
      core_version:
        description: 'Core package version (leave empty to use package.json version)'
        required: false
        type: string
      react_version:
        description: 'React package version (leave empty to use package.json version)'
        required: false
        type: string
      packages:
        description: 'Packages to publish'
        required: true
        type: choice
        default: 'both'
        options:
          - 'both'
          - 'core'
          - 'react'
      npm_tag:
        description: 'NPM dist-tag (auto = detect from version)'
        required: false
        type: choice
        default: 'auto'
        options:
          - 'auto'
          - 'latest'
          - 'beta'
          - 'alpha'
          - 'next'
      dry_run:
        description: 'Dry run (preview without publishing)'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  id-token: write

jobs:
  publish:
    name: Build & Publish to Public NPM
    runs-on: ubuntu-22.04-2cpu-8ram-75ssd
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4
        with:
          version: 10.6.5

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: '20'
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm run build

      - name: Detect versions and npm tags
        id: detect
        run: |
          CORE_VERSION=$(node -p "require('./packages/core/package.json').version")
          REACT_VERSION=$(node -p "require('./packages/react/package.json').version")

          determine_tag() {
            local version=$1
            if [[ "$version" == *"alpha"* ]]; then
              echo "alpha"
            elif [[ "$version" == *"beta"* ]]; then
              echo "beta"
            elif [[ "$version" == *"rc"* ]]; then
              echo "next"
            else
              echo "latest"
            fi
          }

          CORE_TAG=$(determine_tag "$CORE_VERSION")
          REACT_TAG=$(determine_tag "$REACT_VERSION")

          echo "Detected package versions and tags from package:"
          echo "Core Version: $CORE_VERSION"
          echo "React Version: $REACT_VERSION"
          echo "Core Tag: ${CORE_TAG}"
          echo "React Tag: ${REACT_TAG}"

          echo "Setting environment variables: core_version, react_version, core_npm_tag & react_npm_tag"
          echo "core_version=${CORE_VERSION}" >> $GITHUB_ENV
          echo "react_version=${REACT_VERSION}" >> $GITHUB_ENV
          echo "core_npm_tag=${CORE_TAG}" >> $GITHUB_ENV
          echo "react_npm_tag=${REACT_TAG}" >> $GITHUB_ENV

      - name: Set finalized versions, tags and packages to publish
        id: final
        env:
          CORE_VER: ${{ github.event.inputs.core_version }}
          REACT_VER: ${{ github.event.inputs.react_version }}
          NPM_TAG_INPUT: ${{ github.event.inputs.npm_tag }}
          PACKAGES_INPUT: ${{ github.event.inputs.packages }}
        run: |
          # Validation(Sanitize) function, exit on invalid input
          validate_input() {
              local input="$1"
              # Allow empty input
              if [[ -z "$input" ]]; then
                  echo ""
                  return 0
              fi
              if [[ "$input" =~ ^[a-zA-Z0-9._-]+$ ]]; then
                  echo "$input"
              else
                  echo "Invalid input: $input" >&2
                  exit 1
              fi
          }

          # Validate user inputs for malicious content, exit if invalid
          validate_input "$CORE_VER" || exit 1
          validate_input "$REACT_VER" || exit 1
          validate_input "$NPM_TAG_INPUT" || exit 1
          validate_input "$PACKAGES_INPUT" || exit 1

          if [ -z "$CORE_VER" ]; then
            CORE_VER="$core_version"
          fi

          if [ -z "$REACT_VER" ]; then
            REACT_VER="$react_version"
          fi

          if [ "$NPM_TAG_INPUT" = "auto" ] || [ -z "$NPM_TAG_INPUT" ]; then
            CORE_TAG="$core_npm_tag"
            REACT_TAG="$react_npm_tag"
          else
            CORE_TAG="$NPM_TAG_INPUT"
            REACT_TAG="$NPM_TAG_INPUT"
          fi

          # Assign final tag values into environment variables
          echo "CORE_VER=${CORE_VER}" >> $GITHUB_ENV
          echo "REACT_VER=${REACT_VER}" >> $GITHUB_ENV
          echo "CORE_TAG=${CORE_TAG}" >> $GITHUB_ENV
          echo "REACT_TAG=${REACT_TAG}" >> $GITHUB_ENV
          echo "PACKAGES_INPUT=${PACKAGES_INPUT}" >> $GITHUB_ENV

          echo "Publishing:"
          echo "Core: ${CORE_VER} @ ${CORE_TAG}"
          echo "React: ${REACT_VER} @ ${REACT_TAG}"
          echo "Packages: ${PACKAGES_INPUT}"

      - name: Update Core package for public npm
        if: |
          (env.PACKAGES_INPUT == 'both' || env.PACKAGES_INPUT == 'core')
        working-directory: ./packages/core
        run: |
          node -e "
            const pkg = require('./package.json');
            pkg.version = process.env.CORE_VER;
            
            pkg.publishConfig = {
              access: 'public',
              registry: 'https://registry.npmjs.org/'
            };
            
            require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

      - name: Update React package for public npm
        if: |
          (env.PACKAGES_INPUT == 'both' || env.PACKAGES_INPUT == 'react')
        working-directory: ./packages/react
        run: |
          node -e "
            const pkg = require('./package.json');
            pkg.version = process.env.REACT_VER;
            
            pkg.publishConfig = {
              access: 'public',
              registry: 'https://registry.npmjs.org/'
            };
            
            if (pkg.dependencies && pkg.dependencies['@auth0/web-ui-components-core']) {
              pkg.dependencies['@auth0/web-ui-components-core'] = process.env.CORE_VER;
            }
            
            require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

      - name: Publish Core package to public npm
        id: publish-core
        if: |
          (env.PACKAGES_INPUT == 'both' || env.PACKAGES_INPUT == 'core')
        working-directory: ./packages/core
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          current_version=$(node -p "require('./package.json').version")
          echo "Publishing @auth0/web-ui-components-core@$current_version with tag: $CORE_TAG"

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "DRY RUN - Skipping publish"
            pnpm publish --dry-run --no-git-checks --tag="$CORE_TAG"
            echo "published=dry-run" >> $GITHUB_OUTPUT
            echo "version=$current_version" >> $GITHUB_OUTPUT

            echo "Published @auth0/web-ui-components-core@$current_version (dry run)"
          else
            pnpm publish --no-git-checks --tag="$CORE_TAG"
            echo "published=true" >> $GITHUB_OUTPUT
            echo "version=$current_version" >> $GITHUB_OUTPUT
            echo "Published @auth0/web-ui-components-core@$current_version"
          fi

      - name: Publish React package to public npm
        id: publish-react
        if: |
          (env.PACKAGES_INPUT == 'both' || env.PACKAGES_INPUT == 'react')
        working-directory: ./packages/react
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          current_version=$(node -p "require('./package.json').version")
          echo "Publishing @auth0/web-ui-components-react@$current_version with tag: $REACT_TAG"

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "DRY RUN - Skipping publish"
            pnpm publish --dry-run --no-git-checks --tag="$REACT_TAG"
            echo "published=dry-run" >> $GITHUB_OUTPUT
            echo "version=$current_version" >> $GITHUB_OUTPUT
          else
            pnpm publish --no-git-checks --tag="$REACT_TAG"
            echo "published=true" >> $GITHUB_OUTPUT
            echo "version=$current_version" >> $GITHUB_OUTPUT
            echo "Published @auth0/web-ui-components-react@$current_version"
          fi

      - name: Generate Summary
        run: |
          echo "## Public NPM Publication Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "### DRY RUN MODE" >> $GITHUB_STEP_SUMMARY
            echo "No packages were published. This was a test run." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "### Published Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.publish-core.outputs.published }}" != "" ]; then
            echo "- \`@auth0/web-ui-components-core@${CORE_VER}\`" >> $GITHUB_STEP_SUMMARY
            echo "  - Tag: \`${CORE_TAG}\`" >> $GITHUB_STEP_SUMMARY
            echo "  - Registry: https://registry.npmjs.org" >> $GITHUB_STEP_SUMMARY
            echo "  - Install: \`npm install @auth0/web-ui-components-core@${CORE_TAG}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.publish-react.outputs.published }}" != "" ]; then
            echo "- \`@auth0/web-ui-components-react@${REACT_VER}\`" >> $GITHUB_STEP_SUMMARY
            echo "  - Tag: \`${REACT_TAG}\`" >> $GITHUB_STEP_SUMMARY
            echo "  - Registry: https://registry.npmjs.org" >> $GITHUB_STEP_SUMMARY
            echo "  - Install: \`npm install @auth0/web-ui-components-react@${REACT_TAG}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "### Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.publish-core.outputs.published }}" != "" ]; then
            echo "- [View @auth0/web-ui-components-core on npm](https://www.npmjs.com/package/@auth0/web-ui-components-core)" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.publish-react.outputs.published }}" != "" ]; then
            echo "- [View @auth0/web-ui-components-react on npm](https://www.npmjs.com/package/@auth0/web-ui-components-react)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Your internal JFrog registry continues to use \`@auth0-web-ui-components/*\` packages." >> $GITHUB_STEP_SUMMARY

      - name: Create Git tags
        if: github.event.inputs.dry_run != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ "${{ steps.publish-core.outputs.published }}" = "true" ]; then
            TAG_NAME="core@$CORE_VER"
            git tag -a "$TAG_NAME" -m "Release @auth0/web-ui-components-core@$CORE_VER"
            git push origin "$TAG_NAME"
            echo "Created tag: $TAG_NAME"
          fi

          if [ "${{ steps.publish-react.outputs.published }}" = "true" ]; then
            TAG_NAME="react@$REACT_VER"
            git tag -a "$TAG_NAME" -m "Release @auth0/web-ui-components-react@$REACT_VER"
            git push origin "$TAG_NAME"
            echo "Created tag: $TAG_NAME"
          fi

      - name: Create GitHub Release for Core
        if: |
          github.event.inputs.dry_run != 'true' && 
          steps.publish-core.outputs.published == 'true'
        uses: softprops/action-gh-release@c062e08bd532815e2082a85e87e3ef29c3e6d191 # v2
        with:
          tag_name: core@${{ env.CORE_VER }}
          name: '@auth0/web-ui-components-core@${{ env.CORE_VER }}'
          body: |
            Published to NPM

            **Package**: `@auth0/web-ui-components-core`
            **Version**: `${{ env.CORE_VER }}`
            **NPM Tag**: `${{ env.CORE_TAG }}`

            ```bash
            npm install @auth0/web-ui-components-core@${{ env.CORE_VER }}
            ```

            [View on NPM](https://www.npmjs.com/package/@auth0/web-ui-components-core/v/${{ env.CORE_VER }})
          prerelease: ${{ env.CORE_TAG != 'latest' }}
          draft: false

      - name: Create GitHub Release for React
        if: |
          github.event.inputs.dry_run != 'true' && 
          steps.publish-react.outputs.published == 'true'
        uses: softprops/action-gh-release@c062e08bd532815e2082a85e87e3ef29c3e6d191 # v2
        with:
          tag_name: react@${{ env.REACT_VER }}
          name: '@auth0/web-ui-components-react@${{ env.REACT_VER }}'
          body: |
            Published to NPM

            **Package**: `@auth0/web-ui-components-react`
            **Version**: `${{ env.REACT_VER }}`
            **NPM Tag**: `${{ env.REACT_TAG }}`
            **Requires**: `@auth0/web-ui-components-core@${{ env.CORE_VER }}`

            ```bash
            npm install @auth0/web-ui-components-react@${{ env.REACT_VER }}
            ```

            [View on NPM](https://www.npmjs.com/package/@auth0/web-ui-components-react/v/${{ env.REACT_VER }})
          prerelease: ${{ env.REACT_TAG != 'latest' }}
          draft: false

      - name: Restore package.json files
        if: always()
        run: |
          git checkout packages/core/package.json packages/react/package.json || true
